<!DOCTYPE html><html lang="zh"><head><link rel="manifest" href="/manifest.json"><meta charset="utf-8"><title>Coherent Line Drawing | SSARCandy&#39;s Blog</title><meta name="google-site-verification" content="uUti8Shw9zIz5j2Rs_nwYT9VusmIOXijBuf2bBNYm78"><meta http-equiv="Cache-control" content="public"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#673AB7"><meta name="keywords" content="c++,opencv,rendering,paper"><meta name="description" content="線條藝術畫(line drawing) 是最簡單的一種視覺呈現圖畫的方式，僅僅是幾條線條即能清楚的表示出圖片中的物件。這篇論文(Coherent Line Drawing’ by Kang et al, Proc. NPAR 2007)提出一個全自動的方法，可以將相片轉換成簡單、高品質的線條畫風格圖片。"><meta property="og:type" content="article"><meta property="og:title" content="Coherent Line Drawing"><meta property="og:url" content="https://ssarcandy.tw/2017/06/26/Coherent-Line-Drawing/index.html"><meta property="og:site_name" content="SSARCandy&#39;s Blog"><meta property="og:description" content="線條藝術畫(line drawing) 是最簡單的一種視覺呈現圖畫的方式，僅僅是幾條線條即能清楚的表示出圖片中的物件。這篇論文(Coherent Line Drawing’ by Kang et al, Proc. NPAR 2007)提出一個全自動的方法，可以將相片轉換成簡單、高品質的線條畫風格圖片。"><meta property="og:locale" content="zh_TW"><meta property="og:image" content="https://ssarcandy.tw/img/2017-06-26/01.jpg"><meta property="og:image" content="https://ssarcandy.tw/img/2017-06-26/02.jpg"><meta property="og:image" content="https://ssarcandy.tw/img/2017-06-26/03.jpg"><meta property="og:image" content="https://ssarcandy.tw/img/2017-06-26/04.jpg"><meta property="og:image" content="https://ssarcandy.tw/img/2017-06-26/05.jpg"><meta property="og:image" content="https://ssarcandy.tw/img/2017-06-26/06.jpg"><meta property="og:image" content="https://ssarcandy.tw/img/2017-06-26/07.jpg"><meta property="og:image" content="https://ssarcandy.tw/img/2017-06-26/08.jpg"><meta property="og:image" content="https://ssarcandy.tw/img/2017-06-26/09.jpg"><meta property="og:image" content="https://ssarcandy.tw/img/2017-06-26/10.jpg"><meta property="article:published_time" content="2017-06-25T16:14:38.000Z"><meta property="article:modified_time" content="2020-02-02T09:31:32.488Z"><meta property="article:author" content="許書軒"><meta property="article:tag" content="c++"><meta property="article:tag" content="opencv"><meta property="article:tag" content="rendering"><meta property="article:tag" content="paper"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://ssarcandy.tw/img/2017-06-26/01.jpg"><link rel="alternative" href="/atom.xml" title="SSARCandy&#39;s Blog" type="application/atom+xml"><meta name="summary" content="&lt;p&gt;線條藝術畫(line drawing) 是最簡單的一種視覺呈現圖畫的方式，僅僅是幾條線條即能清楚的表示出圖片中的物件。&lt;br&gt;這篇論文(Coherent Line Drawing’ by Kang et al, Proc. NPAR 2007)提出一個全自動的方法，可以將相片轉換成簡單、高品質的線條畫風格圖片。&lt;/p&gt;
&lt;div&gt;
            &lt;img src=&#34;/img/2017-06-26/01.jpg&#34; alt=&#34;輸入一張影像，即可產生出一張線條藝術風格畫。&#34; data-action=&#34;zoom&#34;&gt;
          &lt;/div&gt;"><meta name="Description" content="ssarcandy&#39;s blog. There is always more than one solution."><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/style.css"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"><link rel="manifest" href="/web-app-manifest.json"><script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script><meta name="generator" content="Hexo 4.1.1"></head><body><div id="loading" class="active"></div><nav id="menu" class="hide"><div class="inner flex-row-vertical"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off"><i class="icon icon-lg material-icons">close</i></a><div class="brand-wrap"><div class="brand"><a href="/about" class="avatar"><img alt="ssarcandy" src="/img/logo.png"></a><hgroup class="introduce"><h5 class="nickname">許書軒</h5><div class="mail">There is always more than one solution.</div></hgroup></div></div><ul class="nav flex-col"><li class="waves-block waves-effect" style="line-height:44px;height:44px;padding:0 0"><a href="/about"><i class="material-icons icon icon-lg">person</i> <span>About</span></a></li><li class="waves-block waves-effect" style="line-height:44px;height:44px;padding:0 0"><a href="/"><i class="material-icons icon icon-lg">description</i> <span>Posts</span></a></li><li class="waves-block waves-effect" style="line-height:44px;height:44px;padding:0 0"><a href="/archives"><i class="material-icons icon icon-lg">view_list</i> <span>Archives</span></a></li><li class="waves-block waves-effect" style="line-height:44px;height:44px;padding:0 0"><a href="/projects"><i class="material-icons icon icon-lg">code</i> <span>Projects</span></a></li><li class="waves-block waves-effect" style="line-height:44px;height:44px;padding:0 0"><a href="https://github.com/SSARCandy" target="_blank" rel="noopener"><i class="icon icon-lg icon-github"></i> <span>Github</span></a></li></ul><footer class="footer"><p>Total visitors: 46,304</p><p>SSARCandy &copy; 2016 - 2020</p><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-2x icon-rss-square"></i></a></footer></div></nav><main id="main"><header class="top-header" id="header"><div class="flex-row"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle"><i class="icon icon-lg material-icons">menu</i></a><div class="flex-col header-title ellipsis">Coherent Line Drawing</div><div class="search-wrap" id="search-wrap"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back"><i class="icon icon-lg material-icons">navigate_before</i> </a><input type="text" id="key" class="search-input" aria-label="search-box" autocomplete="off" placeholder="Keywords"> <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search"><i class="icon icon-lg material-icons">search</i></a></div></div></header><header class="content-header"><div class="container"><h1 class="author">Coherent Line Drawing</h1><h5 class="subtitle"><time datetime="2017-06-25T16:14:38.000Z" itemprop="datePublished" class="page-time">Jun 26 2017</time></h5></div></header><aside class="post-widget" id="post-widget"><nav class="post-toc-wrap" id="post-toc"><h4>Contents</h4><ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Implementation"><span class="post-toc-text">Implementation</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Edge-Tangent-Flow"><span class="post-toc-text">Edge Tangent Flow</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Generate-initial-ETF"><span class="post-toc-text">Generate initial ETF</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Refining-ETF"><span class="post-toc-text">Refining ETF</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Line-construction"><span class="post-toc-text">Line construction</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Flow-based-Difference-of-Gaussians"><span class="post-toc-text">Flow-based Difference-of-Gaussians</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Iterative-FDoG-filtering"><span class="post-toc-text">Iterative FDoG filtering</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Results"><span class="post-toc-text">Results</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Source-code"><span class="post-toc-text">Source code</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Reference"><span class="post-toc-text">Reference</span></a></li></ol></nav></aside><div class="container body-wrap" id="body-wrap"><article id="post-Coherent-Line-Drawing" class="article article-type-post" itemprop="blogPost"><div class="post-meat flex-row"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/" rel="tag">c++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/opencv/" rel="tag">opencv</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/paper/" rel="tag">paper</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rendering/" rel="tag">rendering</a></li></ul></div><div class="post-meat" style="color:grey;font-size:13px"><i class="icon icon-sm icon-eye" aria-hidden="true"></i> 1,241</div><div class="post-body"><div class="post-main"><div class="post-content" id="post-content" itemprop="postContent"><p>線條藝術畫(line drawing) 是最簡單的一種視覺呈現圖畫的方式，僅僅是幾條線條即能清楚的表示出圖片中的物件。<br>這篇論文(Coherent Line Drawing’ by Kang et al, Proc. NPAR 2007)提出一個全自動的方法，可以將相片轉換成簡單、高品質的線條畫風格圖片。</p><div><img src="/img/2017-06-26/01.jpg" alt="輸入一張影像，即可產生出一張線條藝術風格畫。" data-action="zoom"><span class="image-caption">輸入一張影像，即可產生出一張線條藝術風格畫。</span></div><a id="more"></a><h1 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h1><p>本篇論文的方法主要流程如下：</p><ol><li>由輸入影像產生邊緣向量流場</li><li>反覆的精煉、平滑化邊緣向量流場</li><li>藉由邊緣向量流場的資訊，對原圖套用高斯差以產生特徵線條</li></ol><div><img src="/img/2017-06-26/02.jpg" alt="整個方法的流程圖： 由原圖產生邊緣向量流場，再藉由流場資訊套用高斯差產生線條畫。" data-action="zoom"><span class="image-caption">整個方法的流程圖： 由原圖產生邊緣向量流場，再藉由流場資訊套用高斯差產生線條畫。</span></div><h2 id="Edge-Tangent-Flow"><a href="#Edge-Tangent-Flow" class="headerlink" title="Edge Tangent Flow"></a>Edge Tangent Flow</h2><p>由於線條畫的特性希望是能夠保留原圖重要的特徵邊緣，所以對應的邊緣向量流場(Edge Tangent Flow)必須滿足幾個條件：</p><ol><li>可以描述重要邊緣的流向。</li><li>鄰近的向量必須要平滑(避免鄰近的向量方向差太多)，除非是角落。</li><li>重要的邊緣必須要維持它原本的方向。</li></ol><h3 id="Generate-initial-ETF"><a href="#Generate-initial-ETF" class="headerlink" title="Generate initial ETF"></a>Generate initial ETF</h3><p>而本篇產生 ETF 的方法是藉由反覆的平滑化流場來得到一個符合上述各個條件的 ETF。<br>首先，藉由 原圖產生灰階梯度流場 (Gradient Vector Field)，再逆時鐘旋轉 90 度來 產生初始的邊 緣向量流場 (ETF)。</p><div><img src="/img/2017-06-26/03.jpg" alt="對原圖做適當模糊後即可取得灰階梯度向量(GVF)，再旋轉 90 度可得一個初始的 ETF。" data-action="zoom"><span class="image-caption">對原圖做適當模糊後即可取得灰階梯度向量(GVF)，再旋轉 90 度可得一個初始的 ETF。</span></div><h3 id="Refining-ETF"><a href="#Refining-ETF" class="headerlink" title="Refining ETF"></a>Refining ETF</h3><p>再將這個初始的 ETF 做平滑化，方法如下：</p><p>$$<br>t^{new}=\dfrac {1} {k}\sum _{y\in \Omega \left( x\right) }\phi \left( x,y\right) t^{cur}\left(y\right)w_{s}\left( x,y\right)w_{m}\left( x,y\right)w_{d}\left( x,y\right)<br>$$</p><p>其中，<br>\(w_{s}\left( x,y\right)\) 是一個圓形 box filter function，落在外面的向量權重為零<br>\(w_{m}\left( x,y\right)\) 為 magnitude weight function，用於確保重要的邊緣方向會被保留<br>\(w_{d}\left( x,y\right)\) 為 direction weight function，用於使得鄰居的向量方向不會差距過大<br>\(\phi \left( x,y\right)\) 則是當兩向量夾角過大時會反轉方向以確保夾角不會大於 90 度</p><p>透過以上的方法，只須要決定 kernel size 即可反覆平滑化 即可反覆平滑化 邊緣向量流場 直至夠平 滑為止 。</p><div><img src="/img/2017-06-26/04.jpg" alt="由左至右：原圖、用 GVF 得到之初始 ETF、經過一次平滑化、經過兩次平滑化。 kernel size=7" data-action="zoom"><span class="image-caption">由左至右：原圖、用 GVF 得到之初始 ETF、經過一次平滑化、經過兩次平滑化。 kernel size=7</span></div><h2 id="Line-construction"><a href="#Line-construction" class="headerlink" title="Line construction"></a>Line construction</h2><p>有了 ETF 之後就可以進入下一步：產生線條。<br>比起一般邊緣偵測的方法如 Sobel、Canny 等等固定 kernel size，這篇論文的方法則是使用 flow-based kernel ，也就是 kernel 會沿著流場有著不一樣的形狀。</p><div><img src="/img/2017-06-26/05.jpg" alt="(a)原圖、(b)ETF、(c)沿著流場的 kernel。<sup>[1]</sup>" data-action="zoom"><span class="image-caption">(a)原圖、(b)ETF、(c)沿著流場的 kernel。<sup>[1]</sup></span></div><h3 id="Flow-based-Difference-of-Gaussians"><a href="#Flow-based-Difference-of-Gaussians" class="headerlink" title="Flow-based Difference-of-Gaussians"></a>Flow-based Difference-of-Gaussians</h3><p>根據 flow-based kernel 來進行 Difference-of-Gaussians(DoG) ，藉此來找出足夠符合重要線條的像素們。</p><div><img src="/img/2017-06-26/06.jpg" alt="(d)kernel 詳細圖示、(e)高斯差示意圖。<sup>[1]</sup>" data-action="zoom"><span class="image-caption">(d)kernel 詳細圖示、(e)高斯差示意圖。<sup>[1]</sup></span></div><p>首先先對每個像素沿著 ETF 垂直方向做一維的 DoG，亦即對圖中 -T~T 做 DoG：</p><p>$$<br>F\left( s\right) =\int _{-T}^{T}I\left( l_{s}\left( t\right) \right) f\left( t\right) dt<br>$$</p><p>其中 \(f\left( t\right) = G_{\sigma_{c}}\left( t \right)-\rho G_{\sigma_{s}}\left( t \right)\) 就是高斯差的部分。</p><p>再來再沿著 -S~S 做一維的高斯加權：</p><p>$$<br>G\left( x\right) =\int _{-S}^{S}G_{\sigma}\left( s \right) F\left( s\right) ds<br>$$</p><p>這樣的方法除了可以使邊緣更有一致性(不會有太多短線)並且又可以抑制雜訊，使得產生出的結果很符合線條畫的特性。這即是這篇所提出的 Flow-based Difference of Gaussians(FDoG)。</p><h3 id="Iterative-FDoG-filtering"><a href="#Iterative-FDoG-filtering" class="headerlink" title="Iterative FDoG filtering"></a>Iterative FDoG filtering</h3><p>有時候做一次 FDoG 效果並不夠好，所以可以藉由反覆做 FDoG 來達到更良好的效果。<br>要反覆套用 FDoG 也很容易，只要將原圖與 FDoG 的輸出疊合，然後以這新的圖片當作原圖再次套用一次 FDoG 即可。</p><div><img src="/img/2017-06-26/07.jpg" alt="藉由將結果疊合回原圖再做一次 FDoG，可以使的結果品質越來越好。" data-action="zoom"><span class="image-caption">藉由將結果疊合回原圖再做一次 FDoG，可以使的結果品質越來越好。</span></div><p>實作上也很簡單，就是把結果的黑色部分直接覆蓋在原圖然後拿這再做 FDoG。注意雖然原圖改變了，但是使用的 ETF 並沒有重新計算。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Superimposing the black edge pixels of the previous binary output</span></span><br><span class="line"><span class="comment"> * upon the original image</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; originalImg.rows; y++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; originalImg.cols; x++) &#123;</span><br><span class="line">        <span class="keyword">float</span> H = result.at&lt;uchar&gt;(y, x);</span><br><span class="line">        <span class="keyword">if</span> (H == <span class="number">0</span>) &#123;</span><br><span class="line">            originalImg.at&lt;uchar&gt;(y, x) = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Results"><a href="#Results" class="headerlink" title="Results"></a>Results</h1><p>基本上圖片在 512x512 左右的大小可以在 3 秒內產生結果，若平行化則即使是更大張的圖片也可達到 real time。</p><div style="display:flex;align-items:center"><div><img src="/img/2017-06-26/08.jpg" alt="輸入影像。由左上至右下：蔣公、廟、燈塔、老鷹。" data-action="zoom"><span class="image-caption">輸入影像。由左上至右下：蔣公、廟、燈塔、老鷹。</span></div><div><img src="/img/2017-06-26/09.jpg" alt="輸出結果。由左上至右下：蔣公、廟、燈塔、老鷹。" data-action="zoom"><span class="image-caption">輸出結果。由左上至右下：蔣公、廟、燈塔、老鷹。</span></div></div><h1 id="Source-code"><a href="#Source-code" class="headerlink" title="Source code"></a>Source code</h1><p>You can find my implementation source code at <a href="https://github.com/SSARCandy/Coherent-Line-Drawing" target="_blank" rel="noopener">github</a><br>Or download pre-build version <a href="https://github.com/SSARCandy/Coherent-Line-Drawing/releases" target="_blank" rel="noopener">here</a></p><div><img src="/img/2017-06-26/10.jpg" alt="Screenshot of my system user interface" data-action="zoom"><span class="image-caption">Screenshot of my system user interface</span></div><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p>[1] Image from ‘Coherent Line Drawing’ by Kang et al, Proc. NPAR 2007</p></div><nav class="post-nav"><div class="waves-block waves-effect prev fl"><a href="/2017/07/21/about-taking-case/" id="post-prev" class="post-nav-link"><div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div><h4 class="title">接案三兩事</h4></a></div><div class="waves-block waves-effect next fr"><a href="/2017/05/26/panorama-image-stitching/" id="post-next" class="post-nav-link"><div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div><h4 class="title">Panorama image stitching</h4></a></div></nav><section id="comments"><div id="disqus_thread"></div><script>!function(){var t=document,e=t.createElement("script");e.src="https://ssarcandy.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript></section></div></div></article><script src="/js/zoom.js"></script><script type="application/ld+json">{
  "@context": "http://schema.org",
  "@type": "Article",
  "mainEntityOfPage": "https://ssarcandy.tw/2017/06/26/Coherent-Line-Drawing/",
  "headline": "Coherent Line Drawing",
  "datePublished": "Mon Jun 26 2017 00:14:38 GMT+0800 (CST)",
  "dateModified": "Mon Jun 26 2017 00:14:38 GMT+0800 (CST)",
  "author": "SSARCandy",
  "image": {
    "@type": "ImageObject",
    "url": "https://ssarcandy.tw/img/2017-06-26/01.jpg"
  },
  "publisher":{ 
    "@type" : "Organization",
    "name": "SSARCandy's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://ssarcandy.tw/img/logo.png"
    }
  }     
}</script></div></main><div class="mask" id="mask"></div><a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light" aria-label="go to top"><span class="icon icon-lg icon-chevron-up"></span></a><script src="/js/global.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/node-waves/0.7.6/waves.min.js"></script><script src="/js/main.js"></script><div class="search-panel" id="search-panel"><ul class="search-result" id="search-result"></ul></div><script type="text/template" id="search-tpl"><li class="item">
    <a href="/{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li></script><script src="/js/search.js"></script><script type="text/javascript">!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-81178870-1","auto"),ga("send","pageview")</script><script>"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js?t=1580635976303").then(function(){console.log("ServiceWorker Register Successfully.")}).catch(function(e){console.error(e)})</script><script type="text/x-mathjax-config">MathJax.Hub.Config("");</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>